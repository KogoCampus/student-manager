name: Deploy API Docs to Github Pages

on:
    push:
        branches:
          - main

jobs:
    build:
        runs-on: [ubuntu-latest]

        strategy:
            matrix:
                node-version: [20.x]
                # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v3
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
            
            - name: Configure AWS Credentials
              run: |
                aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws configure set default.region us-west-2
              shell: bash

            - name: Run install
              uses: borales/actions-yarn@v4
              with:
                cmd: install

            - name: Decrypt secrets for CDK
              uses: borales/actions-yarn@v4
              with:
                cmd: workspace @student-manager/cdk decrypt

            - name: Build the project
              uses: borales/actions-yarn@v4
              with:
                cmd: build

            - name: Copy openapi.yaml to swagger
              run: |
                mkdir -p swagger  # Ensure the target directory exists
                cp packages/cdk/dist/openapi.yaml swagger/openapi.yaml

            - name: Build and Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                  deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
                  publish_dir: ./src/main/swagger-ui
                  publish_branch: gh-pages